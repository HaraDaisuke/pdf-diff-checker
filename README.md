# pdf-diff-checker

## 概要

製造業で利用される設計図面PDFの修正前後を比較し、変更箇所を迅速かつ正確に検出するためのWebシステムです。従来のピクセル単位の差分検出に加え、スキャン時の微妙な位置ズレを自動補正し、図面内の個別の部品を認識して手動で位置を微調整する高度な機能を提供します。

## 機能

### 1. PDF読み込み機能
- Web画面上へのドラッグ＆ドロップによるPDFファイルのアップロード。
- 修正前と修正後のPDFをそれぞれアップロード（基本的には1ページを想定）。

### 2. 比較・差分検出機能
- **自動位置ズレ補正**: スキャン時の微妙な位置ズレ（平行移動）を自動で検出し、画像を補正してから比較を実行。補正によって生じる画面端の不要な差分検出を防止。
- **差分検出の閾値調整**: ピクセル間の色の差がどれくらいであれば差分とみなすかをスライダーで調整可能（0〜800px）。
- **検出対象**: 文字や線画の追加、削除、変更を正確に検出。
- **端の余白を無視**: 画像の上下左右の端から指定したピクセル範囲（0〜100px）は差分検出の対象から除外。スライダーで調整可能。

### 3. 部品検出・手動位置合わせ機能
- **部品の自動検出**: 「修正後」画像内のまとまりのある図形やテキストを自動で検出し、その周囲を四角い枠で囲んで表示。
- **クラスタリング密集度調整**: 検出される部品の粒度（密集度）をスライダーで調整可能（0〜100）。値が大きいほど、近くの部品が結合され、検出数が減る。
- **部品の選択**: 検出された部品の枠を画面上でクリックすることで、特定の部品を選択状態にできる。
- **選択部品の手動位置合わせ**: 選択された部品を「修正前」画像内で最も一致する位置に自動で移動させ、その状態を反映した上で再度差分比較を実行。この変更は永続的に保持される。

### 4. UI表示機能
- **表示方式**: 修正前PDFの画像に、差分箇所を重ねて表示。
- **マーキング**: 検出された差分箇所を赤いハイライトで強調表示。ハイライトの太さもスライダーで調整可能（1〜20px）。
- **コントロール**: 各種設定（差分検出の閾値、ハイライトの太さ、クラスタリング密集度、端の余白）を調整するためのスライダー群。
- **エクスポート**: 「PDFでエクスポート」ボタンにより、差分ハイライト付き画像をPDF形式でダウンロード。
- **部品操作**: 「選択部品を最適位置に移動」ボタンにより、選択された部品を移動し、再比較を実行。

## 技術スタック

### バックエンド
- **FastAPI**: Python製のWebフレームワーク。
- **Python**: プログラミング言語。
- **ライブラリ**: 
  - `PyMuPDF`: PDFから画像を抽出。
  - `OpenCV`: 画像処理、差分検出、位置合わせ、部品検出。
  - `Pillow`: 画像処理。
  - `Numpy`: 数値計算。

### フロントエンド
- **Vue.js**: JavaScriptフレームワーク。
- **Vuetify**: Vue.js用UIコンポーネントフレームワーク。

## セットアップ

### 前提条件
- Python 3.8+
- Node.js (npm)

### 1. プロジェクトのクローン
```bash
git clone [リポジトリのURL]
cd pdf-diff-checker
```

### 2. バックエンドのセットアップ
```bash
cd backend
python3 -m venv venv
source venv/bin/activate  # Windowsの場合は .\venv\Scripts\activate
pip install -r requirements.txt # requirements.txtがない場合は以下を実行
pip install fastapi uvicorn python-multipart PyMuPDF Pillow opencv-python numpy
```

### 3. フロントエンドのセットアップ
```bash
cd frontend
npm install
```

## 実行方法

### 1. バックエンドサーバーの起動
新しいターミナルを開き、バックエンドディレクトリで以下を実行します。
```bash
cd backend
source venv/bin/activate
uvicorn main:app --reload
```

### 2. フロントエンド開発サーバーの起動
別のターミナルを開き、フロントエンドディレクトリで以下を実行します。
```bash
cd frontend
npm run dev
```

ブラウザで `http://localhost:3000` (または `npm run dev` の出力に表示されるURL) にアクセスしてください。

## 使用方法

1.  **PDFのアップロード**: 「修正前のPDF」と「修正後のPDF」のファイル入力欄に、比較したいPDFファイルをドラッグ＆ドロップまたは選択してアップロードします。
2.  **比較の実行**: 「比較する」ボタンをクリックすると、差分検出が実行され、結果画像が表示されます。
3.  **設定の調整**: スライダーを操作して、差分検出の閾値、ハイライトの太さ、クラスタリング密集度、端の余白を調整できます。変更すると自動的に再比較されます。
4.  **部品の操作**: 
    - 検出された部品の枠をクリックすると、その部品が選択されます。
    - 「選択部品を最適位置に移動」ボタンをクリックすると、選択された部品が「修正前」画像内で最適な位置に移動し、その状態が反映された差分画像が再表示されます。
5.  **結果のエクスポート**: 「PDFでエクスポート」ボタンをクリックすると、表示されている差分画像がPDFファイルとしてダウンロードされます。

## 今後の拡張

- 異なるサイズや向きのPDFがアップロードされた場合の処理方法（現状は同サイズ・同向きを前提）。
- 30秒の処理速度目標を達成するための、画像差分アルゴリズムのさらなる最適化。
- 処理中にエラーが発生した場合の、ユーザーへの適切なフィードバック（エラーハンドリング）。
- 複数ページPDFへの対応。
- 回転や拡大縮小を伴う位置ズレへの対応。
