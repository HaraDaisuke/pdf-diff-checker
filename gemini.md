### 📄 システム名：`pdf-diff-checker`

### 📋 1. システム概要
製造業で利用される**設計図面PDF**の修正前後を比較し、変更箇所を迅速かつ正確に検出するためのWebシステム。
従来のピクセル単位の差分検出に加え、**スキャン時の微妙な位置ズレを自動補正**し、**図面内の個別の部品を認識して手動で位置を微調整**する高度な機能を提供します。

---

### ⚙️ 2. 技術要件

*   **バックエンド**: **FastAPI**と**Python**を使用。
    *   **Pythonライブラリ**: `PyMuPDF`（PDFから画像を抽出）、`OpenCV`（画像処理、差分検出、位置合わせ、部品検出）、`Pillow`（画像処理）、`Numpy`（数値計算）を利用。
    *   **設計**: 機能ごとにモジュールを分割し、再利用性を確保。

*   **フロントエンド**: **Vue.js**と**Vuetify**を使用。
    *   **設計**: コンポーネント指向で、UI機能をモジュール化し、保守性を高める。VuetifyによりモダンなUI/UXを実現。

---

### 🚀 3. 機能要件

#### 3-1. PDF読み込み機能
*   **方法**: Web画面上へのドラッグ＆ドロップによるPDFファイルのアップロード。
*   **ファイル形式**: PDF（.pdf）のみに対応。
*   **処理対象**: 修正前と修正後のPDFをそれぞれアップロード。基本的には1ページを想定。

#### 3-2. 画像化処理
*   アップロードされた2つのPDFを、バックエンドのPythonで高解像度の画像データに変換。

#### 3-3. 比較・差分検出機能
*   画像化された2つの設計図面をピクセル単位で比較。
*   **自動位置ズレ補正**: スキャン時の微妙な位置ズレ（平行移動）を自動で検出し、画像を補正してから比較を実行。補正によって生じる画面端の不要な差分検出を防止。
*   **差分検出の閾値調整**: ピクセル間の色の差がどれくらいであれば差分とみなすかをスライダーで調整可能（0〜800px）。
*   **検出対象**: 文字や線画の**追加**、**削除**、**変更**を正確に検出する。
*   **端の余白を無視**: 画像の上下左右の端から指定したピクセル範囲（0〜100px）は差分検出の対象から除外。スライダーで調整可能。
*   **処理速度**: 1ページあたり**30秒以内**での完了を目指す。

#### 3-4. 部品検出・手動位置合わせ機能
*   **部品の自動検出**: 「修正後」画像内のまとまりのある図形やテキストを自動で検出し、その周囲を四角い枠で囲んで表示。
*   **クラスタリング密集度調整**: 検出される部品の粒度（密集度）をスライダーで調整可能（0〜100）。値が大きいほど、近くの部品が結合され、検出数が減る。
*   **部品の選択**: 検出された部品の枠を画面上でクリックすることで、特定の部品を選択状態にできる。
*   **選択部品の手動位置合わせ**: 選択された部品を「修正前」画像内で最も一致する位置に自動で移動させ、その状態を反映した上で再度差分比較を実行。この変更は永続的に保持される。

#### 3-5. UI表示機能
*   **表示方式**: 修正前PDFの画像に、差分箇所を重ねて表示。
*   **マーキング**: 検出された差分箇所を**赤いハイライト**で強調表示。ハイライトの太さもスライダーで調整可能（1〜20px）。
*   **画面構成**:
    *   PDFをアップロードするためのエリア。
    *   比較結果の画像を表示するエリア。
    *   各種設定（差分検出の閾値、ハイライトの太さ、クラスタリング密集度、端の余白）を調整するためのスライダー群。
    *   「PDFでエクスポート」ボタン: 差分ハイライト付き画像をPDF形式でダウンロード。
    *   「選択部品を最適位置に移動」ボタン: 選択された部品を移動し、再比較を実行。

---

### ⚠️ 4. 今後の検討事項

*   異なるサイズや向きのPDFがアップロードされた場合の処理方法（現状は同サイズ・同向きを前提）。
*   30秒の処理速度目標を達成するための、画像差分アルゴリズムのさらなる最適化。
*   処理中にエラーが発生した場合の、ユーザーへの適切なフィードバック（エラーハンドリング）。
*   複数ページPDFへの対応。
*   回転や拡大縮小を伴う位置ズレへの対応。

---

### 📝 5. 処理フロー

#### 5-1. アップロードとリクエスト送信

1.  **ユーザー**: Web画面上で、比較したい2つのPDFファイル（修正前、修正後）をドラッグ＆ドロップで指定します。
2.  **フロントエンド (Vue.js)**: 指定されたPDFファイルと各種設定値（閾値、ハイライト太さ、膨張回数、余白）をバックエンドの**FastAPI**に送信するリクエストを作成します。

#### 5-2. バックエンドでの初期比較処理 (`/api/diff`)

1.  **FastAPI**: リクエストを受け取り、アップロードされた2つのPDFファイルを読み込みます。
2.  **Pythonモジュール（PDF処理）**:
    *   2つのPDFをそれぞれ読み込み、各PDFの1ページ目を高解像度の画像データに変換します。
3.  **Pythonモジュール（グローバル位置合わせ）**:
    *   変換された2つの画像データ間で、全体的な位置ズレ（平行移動）を`OpenCV`の位相相関法で検出します。
    *   「修正後」画像を「修正前」画像に合うように補正します。
4.  **Pythonモジュール（差分検出）**:
    *   位置合わせ後の2つの画像をピクセル単位で比較します。
    *   検出されたズレ量と「端の余白」設定に基づき、比較対象外とするマスク領域を生成します。
    *   色の差が「閾値」を超え、かつマスク領域外のピクセルを差分として特定します。
5.  **Pythonモジュール（画像生成）**:
    *   「修正前」画像データに、特定された差分箇所を赤いハイライトで重ねて描画します。
6.  **Pythonモジュール（部品検出）**:
    *   位置合わせ後の「修正後」画像を二値化し、設定された「クラスタリング密集度」に応じて膨張処理を行います。
    *   `OpenCV`の輪郭検出機能を用いて、画像内の部品のまとまりを検出し、そのバウンディングボックス（四角い枠の座標）を特定します。
7.  **FastAPI**: 生成された「差分ハイライト付き画像」（Base64エンコード）と、検出された部品のバウンディングボックスのリストをJSON形式でフロントエンドに送信します。

#### 5-3. 結果の表示と部品選択

1.  **フロントエンド (Vue.js)**:
    *   バックエンドから受け取ったJSONデータから、差分ハイライト付き画像をWeb画面上に表示します。
    *   検出された部品のバウンディングボックスを、画像の上に半透明のSVG矩形として描画します。
    *   ユーザーは画面上で、赤いハイライトで示された差分箇所を確認できます。
    *   ユーザーは描画された部品の枠をクリックすることで、その部品を選択状態にできます。

#### 5-4. 選択部品の手動位置合わせ処理 (`/api/align-part`)

1.  **ユーザー**: 部品を選択し、「選択部品を最適位置に移動」ボタンをクリックします。
2.  **フロントエンド (Vue.js)**: 元のPDFファイルと各種設定値、および選択された部品の座標をバックエンドの`/api/align-part`に送信するリクエストを作成します。
3.  **FastAPI**: リクエストを受け取り、元のPDFファイルを読み込みます。
4.  **Pythonモジュール（グローバル位置合わせ）**:
    *   まず、元の2つのPDF画像間でグローバルな位置合わせを再度実行し、`aligned_img1`と`aligned_img2`を取得します。
5.  **Pythonモジュール（部品位置合わせ）**:
    *   `aligned_img2`から選択された部品の領域を切り出し、テンプレートとして使用します。
    *   `aligned_img1`内で、このテンプレートが最も一致する最適な位置を`OpenCV`のテンプレートマッチングで探索します。
    *   `aligned_img2`のコピーを作成し、部品の元の位置を`aligned_img1`の対応する背景で埋め、その後、部品を最適な位置に貼り付け直します。
6.  **Pythonモジュール（再比較）**:
    *   `aligned_img1`と、部品が移動された`modified_aligned_img2`を使用して、`5-2`の「差分検出」「画像生成」「部品検出」の処理を再度実行します（ただし、この際のグローバル位置合わせはスキップ）。
7.  **FastAPI**: 新しい差分ハイライト付き画像と部品リストをJSON形式でフロントエンドに送信します。

#### 5-5. 結果の更新

1.  **フロントエンド (Vue.js)**:
    *   バックエンドから受け取った新しい画像と部品リストで画面表示を更新します。
    *   ユーザーは、部品が移動された結果と、それに伴う差分の変化を確認できます。
---